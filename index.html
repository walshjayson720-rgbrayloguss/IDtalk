<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>IDTalk</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: #0f0f0f;
  color: white;
  display: flex;
  height: 100vh;
}

#contacts {
  width: 240px;
  background: #161616;
  padding: 10px;
  box-sizing: border-box;
  overflow-y: auto;
}

#chat {
  flex: 1;
  display: flex;
  flex-direction: column;
}

.contact {
  padding: 8px;
  border-bottom: 1px solid #222;
  cursor: pointer;
}

.contact:hover {
  background: #222;
}

#messages {
  flex: 1;
  padding: 10px;
  overflow-y: auto;
}

.msg {
  margin: 6px 0;
}

.me {
  color: #4caf50;
}

#typing {
  font-size: 12px;
  color: #aaa;
  padding-left: 10px;
}

#input {
  border-top: 1px solid #222;
  padding: 10px;
  background: #111;
}

#input input {
  width: 100%;
  padding: 10px;
  background: #0b0b0b;
  border: none;
  color: white;
  outline: none;
}
</style>
</head>

<body>

<div id="contacts">
  <div><b>Your ID</b></div>
  <div id="myId">loading...</div>

  <hr>

  <input id="newContact" placeholder="Add ID" style="width:100%; margin-bottom:6px;">
  <button onclick="addContact()" style="width:100%;">Add Contact</button>

  <hr>

  <div id="contactList"></div>
</div>

<div id="chat">
  <div id="messages"></div>
  <div id="typing"></div>
  <div id="input">
    <input id="msgInput" placeholder="Type message and press Enter">
  </div>
</div>

<script>
const supabase = supabaseJs.createClient(
  "YOUR_SUPABASE_URL",
  "YOUR_SUPABASE_ANON_KEY"
);

let myId = "";
let currentChat = "";
let channel = null;

async function start() {
  const { data, error } = await supabase.auth.signInAnonymously();
  if (error) {
    alert(error.message);
    return;
  }
  myId = data.user.id;
  document.getElementById("myId").innerText = myId;
  loadContacts();
}
start();

function chatId(a, b) {
  return [a, b].sort().join("_");
}

async function addContact() {
  const id = newContact.value.trim();
  if (!id) return;

  await supabase.from("contacts").insert({
    owner: myId,
    contact_id: id,
    name: id
  });

  newContact.value = "";
  loadContacts();
}

async function loadContacts() {
  const { data } = await supabase
    .from("contacts")
    .select()
    .eq("owner", myId);

  contactList.innerHTML = "";
  data.forEach(c => {
    const d = document.createElement("div");
    d.className = "contact";
    d.innerText = c.name;
    d.onclick = () => openChat(c.contact_id);
    contactList.appendChild(d);
  });
}

async function openChat(otherId) {
  currentChat = chatId(myId, otherId);
  messages.innerHTML = "";
  typing.innerText = "";

  if (channel) supabase.removeChannel(channel);

  const { data } = await supabase
    .from("messages")
    .select()
    .eq("chat_id", currentChat)
    .order("created_at");

  data.forEach(showMessage);

  channel = supabase.channel(currentChat)
    .on(
      "postgres_changes",
      { event: "INSERT", table: "messages", filter: `chat_id=eq.${currentChat}` },
      payload => showMessage(payload.new)
    )
    .on(
      "postgres_changes",
      { event: "INSERT", table: "typing", filter: `chat_id=eq.${currentChat}` },
      payload => {
        if (payload.new.user_id !== myId) {
          typing.innerText = "Typing...";
          setTimeout(() => typing.innerText = "", 1200);
        }
      }
    )
    .subscribe();
}

function showMessage(m) {
  const d = document.createElement("div");
  d.className = "msg";
  if (m.sender === myId) d.classList.add("me");
  d.innerText = m.text;
  messages.appendChild(d);
  messages.scrollTop = messages.scrollHeight;
}

msgInput.addEventListener("keydown", async e => {
  if (!currentChat) return;

  if (e.key === "Enter" && msgInput.value.trim()) {
    await supabase.from("messages").insert({
      chat_id: currentChat,
      sender: myId,
      text: msgInput.value
    });
    msgInput.value = "";
  } else {
    await supabase.from("typing").insert({
      chat_id: currentChat,
      user_id: myId
    });
  }
});
</script>

</body>
</html>
